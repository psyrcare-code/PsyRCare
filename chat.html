<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PsyRCare â€“ Private Conversation</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: 'Playfair Display', serif;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.header {
  padding: 18px;
  border-bottom: 1px solid #333;
  text-align: center;
  font-size: 20px;
}

.chat-box {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.message {
  max-width: 70%;
  margin-bottom: 14px;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.5;
}

.user {
  background: #fff;
  color: #000;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.admin {
  background: #1a1a1a;
  color: #fff;
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.notice {
  text-align: center;
  font-size: 13px;
  opacity: 0.6;
  margin-bottom: 8px;
}

.input-area {
  border-top: 1px solid #333;
  padding: 15px;
  display: flex;
  gap: 10px;
}

input {
  flex: 1;
  padding: 12px;
  background: #000;
  border: 1px solid #444;
  color: white;
  border-radius: 10px;
  outline: none;
}

button {
  padding: 12px 22px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: white;
  color: black;
  transition: 0.3s;
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
</style>
</head>

<body>

<div class="header" id="headerTitle">
  Private Conversation
</div>

<div class="chat-box" id="chatBox"></div>

<div class="notice" id="notice"></div>

<div class="input-area">
  <input type="text" id="messageInput" placeholder="Write your message..." />
  <button id="sendBtn">Send</button>
</div>

<script>
// ===============================
// USER IDENTIFICATION
// ===============================
const userName  = localStorage.getItem("userName")  || "Guest";
const userEmail = localStorage.getItem("userEmail") || "unknown";

// Unique keys per user
const chatKey    = "chat_" + userEmail;
const sessionKey = "sessionOpen_" + userEmail;

// ===============================
// SESSION CONTROL (PER USER)
// ===============================
// false = closed | true = open
let sessionOpen = JSON.parse(localStorage.getItem(sessionKey));
if (sessionOpen === null) {
  sessionOpen = false;
  localStorage.setItem(sessionKey, false);
}

// ===============================
// ELEMENTS
// ===============================
const chatBox = document.getElementById("chatBox");
const input   = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const notice  = document.getElementById("notice");
const header  = document.getElementById("headerTitle");

header.textContent = "Conversation with " + userName;

// ===============================
// LOAD MESSAGES
// ===============================
let messages = JSON.parse(localStorage.getItem(chatKey)) || [];

function renderMessages() {
  chatBox.innerHTML = "";
  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message " + msg.type;
    div.textContent = msg.text;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

renderMessages();

// ===============================
// SESSION STATE
// ===============================
function updateSessionUI() {
  if (!sessionOpen) {
    sendBtn.disabled = true;
    input.disabled = true;
    notice.textContent =
      "Messaging is available only during your scheduled session.";
  } else {
    sendBtn.disabled = false;
    input.disabled = false;
    notice.textContent = "";
  }
}

updateSessionUI();

// ===============================
// SEND MESSAGE
// ===============================
sendBtn.addEventListener("click", () => {
  const text = input.value.trim();
  if (!text) return;

  messages.push({ type: "user", text });
  localStorage.setItem(chatKey, JSON.stringify(messages));
  input.value = "";
  renderMessages();
});

input.addEventListener("keydown", e => {
  if (e.key === "Enter") sendBtn.click();
});
</script>

</body>
</html>
